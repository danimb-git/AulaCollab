generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  
}

model class_members {
  class_id  String   @db.Uuid
  user_id   String   @db.Uuid
  joined_at DateTime @default(now()) @db.Timestamptz(6)
  role_in_class String? @db.VarChar(50)

  classes classes @relation(fields: [class_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users   users   @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([class_id, user_id])
  @@index([user_id], map: "idx_class_members_user")
}

model classes {
  id           String   @id @db.Uuid
  nom          String   @db.VarChar(120)
  descripcio   String?
  professor_id String   @db.Uuid
  created_at   DateTime @default(now()) @db.Timestamptz(6)

  class_members class_members[]
  documents     documents[]
  users         users @relation(fields: [professor_id], references: [id], onUpdate: NoAction)

  @@index([professor_id], map: "idx_classes_professor")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model documents {
  id           String   @id @db.Uuid
  nom          String   @db.VarChar(255)
  storage_path String
  uploader_id  String   @db.Uuid
  class_id     String?  @db.Uuid
  group_id     String?  @db.Uuid
  created_at   DateTime @default(now()) @db.Timestamptz(6)

  classes     classes?     @relation(fields: [class_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  work_groups work_groups? @relation(fields: [group_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users       users        @relation(fields: [uploader_id], references: [id], onUpdate: NoAction)

  @@index([class_id], map: "idx_documents_class")
  @@index([group_id], map: "idx_documents_group")
  @@index([uploader_id], map: "idx_documents_uploader")
}

model group_members {
  group_id  String   @db.Uuid
  user_id   String   @db.Uuid
  joined_at DateTime @default(now()) @db.Timestamptz(6)
  member_role String? @db.VarChar(50)

  work_groups work_groups @relation(fields: [group_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users       users       @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([group_id, user_id])
  @@index([user_id], map: "idx_group_members_user")
}

model messages {
  id           String   @id @db.Uuid
  text         String
  sender_id    String   @db.Uuid
  receiver_id  String?  @db.Uuid
  context_type String   @db.Text
  context_id   String?  @db.Uuid
  created_at   DateTime @default(now()) @db.Timestamptz(6)

  users_messages_receiver_idTousers users? @relation("messages_receiver_idTousers", fields: [receiver_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users_messages_sender_idTousers   users  @relation("messages_sender_idTousers", fields: [sender_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([receiver_id], map: "idx_messages_receiver")
  @@index([sender_id], map: "idx_messages_sender")
  @@index([created_at], map: "idx_messages_time")
  @@index([context_type, context_id, created_at], map: "idx_messages_context_time")
}



model schema_migrations {
  id         Int      @id @default(autoincrement())
  filename   String   @unique
  applied_at DateTime @default(now()) @db.Timestamptz(6)
}

model users {
  id            String    @id @db.Uuid
  nom           String    @db.VarChar(80)
  cognom        String    @db.VarChar(120)
  email         String    @unique @db.VarChar(255)
  password_hash String
  rol           user_role
  created_at    DateTime  @default(now()) @db.Timestamptz(6)

  class_members class_members[]
  classes       classes[]
  documents     documents[]
  group_members group_members[]
  owned_work_groups work_groups[]

  messages_messages_receiver_idTousers messages[] @relation("messages_receiver_idTousers")
  messages_messages_sender_idTousers   messages[] @relation("messages_sender_idTousers")

  @@index([email], map: "idx_users_email")
}

model work_groups {
  id         String   @id @db.Uuid
  nom        String   @db.VarChar(120)
  created_at DateTime @default(now()) @db.Timestamptz(6)

  documents     documents[]
  group_members group_members[]
  descripcio   String?
  owner_id     String?  @db.Uuid
  class_id     String?  @db.Uuid
  owner        users?   @relation(fields: [owner_id], references: [id], onUpdate: NoAction)
  classes      classes? @relation(fields: [class_id], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([owner_id], map: "idx_work_groups_owner")
  @@index([class_id], map: "idx_work_groups_class")
}

enum user_role {
  PROFESSOR
  ALUMNE
  ADMIN
}